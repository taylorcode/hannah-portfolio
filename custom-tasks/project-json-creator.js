// Generated by CoffeeScript 1.6.3
(function() {
  var RSVP, exif, im, jsonKeyMap, titleCaseToDash, _;

  _ = require('underscore');

  exif = require('exif2');

  RSVP = require('rsvp');

  im = require('imagemagick');

  titleCaseToDash = function(value) {
    if (value) {
      return value.replace(/\s+/g, '-').toLowerCase();
    }
  };

  jsonKeyMap = function(categories) {
    return _.map(categories, function(obj, key) {
      return {
        name: key,
        projects: _.map(obj, function(obj, key) {
          return {
            title: key,
            dir: key,
            images: _.map(obj, function(obj, key) {
              var img;
              img = {
                src: titleCaseToDash(key)
              };
              if (obj) {
                img.description = obj;
              }
              return img;
            })
          };
        })
      };
    });
  };

  module.exports = function(grunt) {
    return grunt.registerMultiTask("projectJSON", "Creates project JSON file.", function() {
      var categories, dest, done, exifPromises, src;
      done = this.async();
      src = this.data.src;
      dest = this.data.dest;
      categories = {};
      exifPromises = [];
      grunt.file.recurse(src, function(abspath, rootdir, subdir, filename) {
        var c, category, p, project, subDirParts;
        if (!subdir) {
          return;
        }
        if (filename.charAt(0) === '.') {
          return;
        }
        subDirParts = subdir.split('/');
        category = subDirParts[0];
        project = subDirParts[1];
        if (categories[category]) {
          c = categories[category];
          if (!c[project]) {
            c[project] = {};
          }
          p = c[project];
        } else {
          c = categories[category] = {};
          p = c[project] = {};
        }
        p[filename] = ' ';
        return grunt.file.write(dest, JSON.stringify(jsonKeyMap(categories)));
      });
    });
  };

}).call(this);
